<!DOCTYPE html>
<html>
  <head>
    <title>Fantasy Sports Demo</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <style type="text/less">
        html, body {
            height: 100%;
            min-height: 100%;
        }

        @color-dark: #242a2e;
        @color-medium: lighten(#565656, 20%);
        @color-bright: #f7f7f7;
        @font-family-regular: Arial, sans-serif;
        /*@font-family-bold: 'Montserrat', sans-serif;*/

        @color-border: lighten(#242a2e, 2%);

        .font-20-regular(@line-height: 24px, @font-weight: bold, @color: @color-bright) {
            font-size: 20px;
            line-height: @line-height;
            font-weight: @font-weight;
            font-family: @font-family-regular;
            color: @color;
        }

        .font-12-regular(@line-height: 14px, @font-weight: normal, @color: @color-bright) {
            font-size: 12px;
            line-height: @line-height;
            font-weight: @font-weight;
            font-family: @font-family-regular;
            color: @color;
        }

        .font-12-bold(@line-height: 14px, @font-weight: bold, @color: @color-bright) {
            font-size: 12px;
            line-height: @line-height;
            font-weight: @font-weight;
            font-family: @font-family-regular;
            color: @color;
        }

        .font-16-bold(@line-height: 20px, @font-weight: bold, @color: @color-bright) {
            font-size: 16px;
            line-height: @line-height;
            font-weight: @font-weight;
            font-family: @font-family-regular;
            color: @color;
        }

        .font-26-bold(@line-height: 32px, @font-weight: bold, @color: @color-bright) {
            font-size: 26px;
            line-height: @line-height;
            font-weight: @font-weight;
            font-family: @font-family-regular;
            color: @color;
        }

        body {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: @color-dark;

            color: @color-bright;
            font-family: 'Montserrat', sans-serif;
        }

        @top-section-height: 52px;
        @team-header-height: 44px;
        @bottom-section-height: 44px;
        @right-section-width: 64px;

        .top-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: @top-section-height;
            background-color: @color-medium;

            background-image: url(/badient.png);
            background-position-y: -30px;

            .brand {
                margin: 0 auto;
                width: 200px;

                .font-26-bold(@line-height: 56px);
                text-align: center;
                text-transform: uppercase;
                color: white;
            }
        }

        .team-header {
            position: absolute;
            top: @top-section-height;
            left: 0;
            width: 100%;
            height: @team-header-height;

            background-color: @color-bright;

            margin: 0 auto;
            text-align: center;

            .roster {
                position: relative;
                .font-16-bold(@line-height: @team-header-height, @color: black);

                .roster-name {
                    margin: 0 auto;
                    width: 200px;
                }

                .roster-rank {
                    position: absolute;
                    left: 0;
                    margin-left: 12px;
                    margin-top: -4px;
                }

                .roster-points {
                    position: absolute;
                    right: 0;
                    margin-right: 12px;
                    margin-top: -4px;
                }

                .roster-rank-number,
                .roster-points-number {
                    font-size: 20px;
                }

                .roster-rank-rest {
                    position: absolute;
                    bottom: -12px;
                    left: 2px;
                    font-size: 10px;
                }

                .roster-points-rest {
                    position: absolute;
                    bottom: -12px;
                    right: 2px;
                    font-size: 10px;
                }
            }
        }

        a.name {
            color: white;
        }

        .bottom-section {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;

            height: @bottom-section-height;
            background-color: @color-bright;
            /*background-image: url(/badient.png);*/
            /*background-position-y: -140px;*/

            .last-play {
                margin: 8px;
                .font-12-bold(@color: @color-dark);

                .cta {
                    color: red;
                }
            }
        }

        .left-section {
            position: absolute;
            top: @top-section-height + @team-header-height;
            right: @right-section-width;
            bottom: @bottom-section-height;
            left: 0;

            /*border-right: 1px solid @color-border;*/
            background-color: @color-dark;

            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;

            .roster {
                width: 100%;
            }

            .header {
                display: inline-block;
                width: 100%;
                height: 44px;
                .font-20-regular();
                line-height: 44px;
                border-bottom: 1px solid @color-border;
            }

            .player {
                display: inline-block;
                width: 100%;
                /*height: 32px;*/
                border-bottom: 1px solid @color-border;
                .font-12-regular(@line-height: 44px);

                /*background-image: url(/nfl-header.jpg);*/
                /*-webkit-background-size: cover;*/
                /*background-size: cover;*/
            }

            .profile-pic-container {
                position: relative;
                float: left;
                width: 44px;
                height: 44px;
                margin-right: 8px;
            }

            .profile-pic {
                width: 44px;
                height: 44px;
            }

            .profile-pic-details {
                position: absolute;
                left: 0;
                width: 100%;
                bottom: -1px;
                height: 16px;

                background-color: rgba(22, 22, 22, 50%);
                text-align: center;
            }

            .profile-pic-position {
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;

                line-height: 16px;
            }

            .name {
                margin-top: 6px;
                line-height: 16px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .pos {
                line-height: 16px;
                color: @color-medium;
            }

            .points {
                float: right;
                width: 44px;
                height: 44px;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .total {
                display: inline-block;
                position: relative;
                width: 100%;
                height: 44px;
                .font-20-regular();
                line-height: 44px;
                text-align: center;

                /*background-color: @color-bright;*/
                /*color: black;*/

                .score {
                    position: absolute;
                    top: 0;
                    right: 12px;
                }
            }
        }

        .right-section {
            position: absolute;
            top: @top-section-height + @team-header-height;
            bottom: @bottom-section-height;
            right: 0;

            width: @right-section-width;
            background-color: @color-dark;

            overflow-x: hidden;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;

            .member {
                position: relative;
                height: @right-section-width;
                .font-12-regular(@line-height: 22px);

                background-image: url(https://fbcdn-profile-a.akamaihd.net/hprofile-ak-xap1/v/t1.0-1/p160x160/10538610_10101399014849827_6837924514296375200_n.jpg?oh=899b272c7778c663d1b1a34b5c72a00e&oe=54DF06B8&__gda__=1427980397_1f300688d5f7777e87115e924d64363d);
                -webkit-background-size: cover;
                background-size: cover;
            }

            .standing {
                position: absolute;
                left: 0;
                bottom: 18px;

                width: 100%;

                text-align: center;

                background-color: rgba(22, 22, 22, 50%);
            }

            .rank {
            }

            .name {
            }

            .points {
                position: absolute;
                left: 0;
                bottom: 0;

                width: 100%;

                text-align: center;

                background-color: rgba(22, 22, 22, 50%);
            }
        }

    </style>
    <!-- Latest compiled and minified JavaScript -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.0.0/less.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.1/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.1/JSXTransformer.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1, user-scalable=0, minimal-ui">
  </head>
  <body>
    <div id="app"></div>

    <script>
        data = JSON.parse('<%= page %>')
    </script>

    <script type="text/jsx">

    var TeamsClient = function() {
    }

    TeamsClient.prototype.get = function(teamName, cb) {
        $.ajax({
            url: '/api/teams/' + teamName
          , type: 'GET'
          , dataType: 'json'
          , success: function(data) {
                cb(null, data)
            }
        })
    }

    var teamsClient = new TeamsClient()

    var GamePage = React.createClass({
        mixins: []
      , getInitialState: function() {
            return {
                team: void 0
              , standings: void 0
              , lastPlay: ''
            }
        }
      , componentDidMount: function() {
            var self = this

            setInterval(function() {
                teamsClient.get(data.team, function(e, d) {
                    if (e) {

                    } else {
                        var myRank
                        for (var i = 0, ii = d.standings.length; i < ii; ++i) {
                            if (d.standings[i].name === data.team) {
                                myRank = i + 1
                            }
                        }

                        d.team.rank = myRank
                        d.team.teamCount = d.standings.length

                        var newState = {
                            team: d.team
                          , standings: d.standings
                        }

                        // var rosterIDs = _(d.team.roster).pluck('playerid')

                        // for (var i = 0, ii = d.plays.length; i < ii; ++i) {
                        //     if (rosterIDs.indexOf(d.plays[i].playerid) > -1) {
                        //         newState.lastPlay = d.plays[i]
                        //     }
                        // }
                        // if (d.plays.length) {
                        //     newState.lastPlay = d.plays[0]
                        // }
                        // console.log(newState.lastPlay)
                        newState.lastPlay = d.plays.pop()

                        self.setState(newState)
                    }
                })
            }, 1000)
        }
      , getOrdinal: function(n) {
            if((parseFloat(n) == parseInt(n)) && !isNaN(n)){
                var s=["th","st","nd","rd"],
                v=n%100;
                return n+(s[(v-20)%10]||s[v]||s[0]);
            }
            return n;
        }
      , render: function() {
            if (this.state.team) {
                var roster = this.state.team.roster.map(function(player, i) {

                    var stats =
                        (player.passing_tds + player.rushing_tds + player.receiving_tds) + ' tds, '
                      + (player.passing_yds + player.rushing_yds + player.receiving_yds) + ' yds'

                    return (
                        <div className="player" key={player.playerid}>
                            <div className="profile-pic-container">
                                <img className="profile-pic" src={"/images/players/" + player.playerid + ".png"} />
                                <div className="profile-pic-details">
                                    <span className="profile-pic-position">{player.position}</span>
                                </div>
                            </div>
                            <div className="points">{player.score ? player.score.toFixed(2) : "0.00"}</div>
                            <div className="details">
                                <div className="name">
                                    <a className="name" target="blank" href={player.profile_url}>{player.first_name}&nbsp;{player.last_name}&nbsp;(#{player.uniform_number}, {player.team})</a>
                                </div>
                                <div className="pos">
                                    {stats}
                                </div>
                            </div>
                        </div>
                    )
                })

                var standings = this.state.standings.map(function(user, i) {
                    return (
                        <a href={"/" + user.name} className="name" key={user.name}>
                            <div className="member">
                                <div className="standing">
                                    <span className="rank">{i + 1}</span>&nbsp;<span className="name">{user.name}</span>
                                </div>
                                <div className="points">{user.score.toFixed(0)}&nbsp;pts</div>
                            </div>
                        </a>
                    )
                })

                return (
                    <div>
                        <div className="top-section">
                            <div className="brand">
                                BetFan
                            </div>
                        </div>
                        <div className="team-header">
                            <div className="roster">
                                <div className="roster-rank">
                                    <span className="roster-rank-number">
                                    {this.getOrdinal(this.state.team.rank)}</span><span className="roster-rank-rest">of&nbsp;{this.state.team.teamCount}</span>
                                </div>
                                <div className="roster-points">
                                    <span className="roster-points-number">{this.state.team.score ? this.state.team.score.toFixed(2) : '0.00'}</span><br/><span className="roster-points-rest">pts</span>
                                </div>
                                <div className="roster-name">
                                    {this.state.team.name}'s Team
                                </div>
                            </div>
                        </div>
                        <div className="bottom-section">
                            <div className="last-play">
                                <span className="cta">Last Play:&nbsp;</span>{this.state.lastPlay.description}
                            </div>
                        </div>
                        <div className="left-section">
                            <div className="roster">
                                {/*
                                <div className="header">
                                    <div className="roster-name">Roster</div>
                                </div>
                                */}
                                {roster}
                                <div className="total">
                                    <div className="">Total</div>
                                    <div className="score">{this.state.team.score ? this.state.team.score.toFixed(2) : "0.00"}</div>
                                </div>
                            </div>
                        </div>
                        <div className="right-section">
                            {standings}
                        </div>
                    </div>
                )
            } else {
                return <div></div>
            }
        }
    })


    React.render(
        <GamePage/>,
        document.getElementById('app')
    );

    </script>

    <script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>
  </body>
</html>